<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Cordite Network Map</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
          integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
          crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
          integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
          crossorigin="anonymous"></script>
  <link rel="stylesheet" href="style.css">

</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#"><h1>Cordite NetworkMap Service</h1></a>
    <ul class="navbar-nav mr-auto">

    </ul>
    <ul class="navbar-nav">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink"
           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span id="user">Account</span>
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
          <a class="dropdown-item">Logout</a>
        </div>
      </li>
    </ul>
  </div>
</nav>

<div class="container">
  <div class="row">
    <div class="col">
      <p>Complies with the Network Map REST API standard as described by the
        <a href="https://docs.corda.net/network-map.html">Corda v3 documentation</a></p>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col">
      <h2>Notaries</h2>
      <ul id="notaries" class="list-group"></ul>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col">
      <h2>Whitelist</h2>
      <textarea class="form-control whitelist" id="whitelist" rows="3" readonly title=""></textarea>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col">
      <h2>Nodes</h2>
      <ul id="nodes" class="list-group"></ul>
    </div>
  </div>
</div>
<div class="modal" tabindex="-1" role="dialog" id="authDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content card card-container">
        <img id="profile-img" class="profile-img-card" src="/img/avatar_2x.png"/>
        <p id="profile-name" class="profile-name-card"></p>
        <form class="form-signin" action="" onsubmit="return authenticate(this);">
          <span id="reauth-email" class="reauth-email"></span>
          <input type="text" class="form-control" placeholder="Username" name="username" id="inputUsername" required autofocus>
          <input type="password" class="form-control" placeholder="Password" name="password" id="inputPassword">
          <button class="btn btn-lg btn-primary btn-block btn-signin" type="submit">Sign in</button>
          <div class="error" id="authError"></div>
        </form><!-- /form -->
      </div><!-- /card-container -->
  </div>
</div>

<script>
  let token = "";

  $('#authDialog').modal('show');

  function getData() {
    apiGet("/admin/api/notaries", setupNotaries);
    apiGet("/admin/api/whitelist", setupWhitelist);
    apiGet("/admin/api/nodes", setupNodes);
  }

  function setupNotaries(data) {
    const notaryList = $('#notaries');
    for (let notary of data) {
      const notaryItem = $('<li class="notary list-group-item">');
      const title = $('<div class="notary-name">');
      const key = $('<div class="notary-key">');
      title.text(notary.identity.name);
      key.text(notary.identity.owningKey);
      notaryItem.append(title);
      notaryItem.append(key);
      notaryItem.data('notary', notary);
      notaryList.append(notaryItem);
    }
  }

  function setupWhitelist(data) {
    const wl = $('#whitelist');
    wl.text(data);
  }

  function setupNodes(data) {
    const nodeList = $('#nodes');
    for (let node of data) {
      const nodeItem = $('<li class="node list-group-item">');
      const party = $('<div class="node-name">');
      const host = $('<div class="node-key">');
      const key = $('<div class="node-key">');
      party.text(node.parties[0].name);
      host.text(`${node.addresses[0].host}:${node.addresses[0].port}`);
      key.text(node.parties[0].key);
      nodeItem.append(party);
      nodeItem.append(host);
      nodeItem.append(key);
      nodeItem.data('node', node);
      nodeList.append(nodeItem);
    }
  }

  function authenticate(e) {
    const username = $('#inputUsername').val();
    const password = $('#inputPassword').val();
    $('#authError').text("");
    try {
      $.ajax({
        url: '/admin/api/login',
        dataType: 'text',
        type: 'post',
        contentType: 'application/json',
        data: JSON.stringify({user: username, password: password}),
        success: function (data) {
          token = data;
          $('#authDialog').modal('hide');
          getData();
        },
        error: function (jqXhr, textStatus, errorThrown) {
          console.error(errorThrown);
          $('#authError').text(errorThrown);
        }
      });
    } catch(err) {
      console.error(err);
    }
    return false;
  }

  function apiGet(url, success) {
    $.ajax({
      url: url,
      headers: {
        Authorization: "Bearer " + token
      },
      dataType: 'text'
    })
      .done(data => {
        if (success) {
          const json = JSON.parse(data);
          success(json);
        }
      })
      .fail(err => {
        console.error("error during GET " + url, err);
      })
    ;
  }
</script>
</body>
</html>